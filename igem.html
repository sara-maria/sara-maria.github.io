<!DOCTYPE html>
<html>
<head>
         <!-- Declare the character set of the document -->
        <meta charset="UTF-8">
         <!-- Support IE9-IE10 -->
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
          <!-- Set the viewport -->
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <!-- Page Info -->
        <title>Biota Beats - iGEM - UNIVERSE </title>
        <meta name="author" content="Sara Maria Sprinkhuizen">
        <meta name="description" content="Biota Beats - A microbial record player developed by the EMW Street Bio team.">
        <meta property="og:image" content="./images/motherearth_small.png">
        <meta name="keywords" content="Biota,Beats,iGEM,UNIVERSE,microbiome,microbiota,bacteria,EMW,Street,Bio,record,player,DJ,music,art,data">

        <!-- Javascripts -->
        <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="https://d3js.org/d3-queue.v3.min.js"></script>
<script>

var q = d3.queue();

</script>
    
    <style>
        body {
                overflow:visible;
                background: #131314;
                position: relative;
                }

        #MotherEarth {
                height: 660px;
                width: 800px;
                position:relative;
            padding-top: 50px;
            padding-left: 25px;
                }
            
        #image {
                padding-top: 180px;
                padding-left: 80px;
                position: relative;
                left: 0;
                z-index: -2; /*her hand behind the earth*/ 
                }
        
/*        svg index -1 to ensure overlap with the image divs etc*/
        svg {
                position: absolute;
                left: 0;
                top: 0;
                z-index: -1;
            }

        .city {
                fill: rgb(38, 255, 223);
                stroke: rgb(123, 123, 113);
                stroke-width: 1;
                opacity: 0.6;
            }
            
        .highlight {
                fill: rgb(248, 248, 158);
                stroke: rgb(242, 242, 167);
                stroke-width: 12;
                opacity: 1;
            }

         h2 {
                letter-spacing: 4em;
                position: absolute;
                left: 0;
                top: 0%;
                width: 100%;
                text-align: center;
                font-family:futura;
                font-weight: 100;
                text-align: center;
                font-size: 4em;
                color:rgb(211, 208, 116);
            }    
        
        
/*        For body part highlighting stars: */
        .node {
            fill: #f8f0f0;
            stroke: #fff;
            stroke-width: 0;
            stroke-opacity: 0.3;
            }

        
    </style>
    
    <script type="text/javascript">  
        var margin = 0,
            width = 1900 - margin,
            height = 1100 - margin;
    
    function draw(geo_data) {
    
        d3.select("body").select("#content").append("h2")
            .text("UNIVERSE")
          
        var svg = d3.select("body").select("#content").select("svg")
            .attr("width", width + margin)
            .attr("height", height + margin);
        
        
                ////////////////////////////////////////////////////////////////////////////
                //   STAR MAKING SCRIPT!
                //   From: http://bl.ocks.org/tommyogden/25e565c0a3305644d983
                ////////////////////////////////////////////////////////////////////////////
                (function() {

                  var num_stars = 550;

                  var x = d3.scale.linear()
                      .range([0, width])
                      .domain([0, 1]);

                  var y = d3.scale.linear()
                      .range([height, 0])
                      .domain([0, 1]);

                  // Select SVG and make star group
                  var svg = d3.select("body").select("svg")
                            .append("g")

                  var data_xyr = d3.range(num_stars)
                                  .map(function() { return [Math.random(), Math.random(), 2*Math.random()]; });
                    
                  var color = d3.scale.linear()
                                    .domain([0,250,500,750])
                                    .interpolate(d3.interpolateRgb)
                                    .range([d3.rgb("rgb(255, 255, 131)"), d3.rgb("#9bf2f2"), d3.rgb("rgb(255, 255, 214)"), d3.rgb('#fff')]);

                  var circles = svg.selectAll("circle")
                    .data(data_xyr)
                    .enter().append("circle")
                      .attr("class","stars")
                      .attr("cx", function (d) { return x(d[0]); } )
                      .attr("cy", function (d) { return y(d[1]); } )
                      .style("fill",function(d,i){return color(i);})
                      .attr("r", function (d) { return d[2]; })

                    //Twinkle script from: http://blockbuilder.org/pmplewa/0e36cce6c9c5edb31e18d41ad1f82c4e */
                    d3.selectAll(".stars")
                        .each(function() {
                          var circle = d3.select(this);
                          (function twinkle() {
                            circle.transition()
                              .duration(100 + 480 * Math.random())
                              .ease("linear")
                              .attr("opacity", 0.3 + 0.8 * Math.random())
                              .each("end", twinkle);
                          })();
                        }); //end twinkle

                })();
                ////////////////////////////////////////////////////////////////////////////
                //<!--   END STAR MAKING SCRIPT!-->
                ////////////////////////////////////////////////////////////////////////////
        
        
        /////////////////////////////////////////////////////////////////////////////////////////////
        /////////////////////////////////////////////////////////////////////////////////////////////
        // DRAW GLOBE
        // used: http://bl.ocks.org/PatrickStotz/1f19b3e4cb848100ffd7
        /////////////////////////////////////////////////////////////////////////////////////////////
        /////////////////////////////////////////////////////////////////////////////////////////////
        
                
        var earthcolor = d3.rgb("rgb(105, 113, 142)"); 
        var countryfillcolor = d3.rgb("rgb(84, 94, 139)"); 
        var countrystrokecolor = d3.rgb("rgb(25, 64, 224)"); 
       
        var defs = svg.append("defs");    
                    var radialGradient = defs.append("radialGradient")
                        .attr("id", "radial-gradient")
                        .attr("cx", "50%")    //The x-center of the gradient, same as a typical SVG circle
                        .attr("cy", "50%")    //The y-center of the gradient
                        .attr("r", "50%");   //The radius of the gradient, an offset of 100% ends where you've set this radius
                    //Add colors to make the gradient appear like a Globe:
                    //  From: https://www.visualcinnamon.com/2016/05/data-based-svg-gradient-d3.html
                    radialGradient.append("stop")
                        .attr("offset", "0%")
                        .attr("stop-color", earthcolor.brighter(1));
                    radialGradient.append("stop")
                        .attr("offset", "50%")
                        .attr("stop-color", earthcolor);
                    radialGradient.append("stop")
                        .attr("offset", "90%")
                        .attr("stop-color", earthcolor.darker(3)); 
        
        var rotate = [90, 0];
        var projection = d3.geo.orthographic()
                            .scale(370)
                            .translate([360+width / 2, 100+height / 2])
                            .clipAngle(90) //THIS LINE MAKES GLOBE NON TRANSPARENT!!! http://bl.ocks.org/PatrickStotz/1f19b3e4cb848100ffd7
                          .precision(0.2)  // what is this for?
                            .rotate([rotate[0], rotate[1]]);
        
          var pathproj = d3.geo.path().projection(projection);
                            

        
        // drawing "3D sphere" as landmass
        var g = svg.append("g");
            g.append("path")
               .datum({type: "Sphere"})
               .attr("class", "sphere")
               .attr("d", pathproj)
               .attr("fill", "url(#radial-gradient)");

        // drawing the worldmap
        var map = svg.append('g').selectAll('path')
                     .attr("class", "fill")
                     .data(geo_data.features)
                     .enter()
                     .append('path')
                     .attr('d', pathproj)
                     .style('fill', countryfillcolor)
                     .style('stroke', countrystrokecolor)
                     .style('stroke-width', .5)
                     .style('opacity',.8);
        
                /////////////////////////////////////////////////////////////////////////////////
                //draw, spin, and highlight the cities on the world
        
        
            function plot_points(data) {  
                // Add city points to map!
                    // New attempt: JSON object (instead of circles) for points allowed to be clipped at "backside" of earth:
                    svg.append('g')
                    .selectAll("path")
                        .data(data,function(d,i){ return d.id })    
                        .enter()
                        .append("path")
                        .datum(function(d) {return d3.geo.circle().origin([d.lon, d.lat]).angle(.5)()}) //flat projected discs
//                        .datum(function(d) { console.log(d); //team names and places in disc-circles
//                                return {
//                                    type: "Point",
//                                    coordinates: [d.lon, d.lat]
//                                }; })
                        .attr("class","city")
                        .attr("d", pathproj);

               
                ////////////////////////////////////////////////////////////////////////////////////////////////////                         
                //        Spinning the globe:

                function spinning_globe(){

                var time = Date.now();
                var velocity = [-.002, -0];

                d3.timer(t => {
                    // get current time
                    var dt = Date.now() - time;
                          
                          //Define new projection over a rotating path
                          //projection.rotate([t * 0.015, Math.sin(t * 0.0005) * 45]); //"wobble" spinning
                          projection.rotate([rotate[0] + velocity[0] * dt, rotate[1] + velocity[1] * dt]);
                    
                          //Add new projection to the map
                          map.attr('d', pathproj)

                          // Spin city locations: Method with JSON path element - only requires this line:
                          svg.selectAll("path.city").attr("d", pathproj);

                           }); // end timer spinning globe

                }; // end spinning globe

                spinning_globe();
                ////////////////////////////////////////////////////////////////////////////////////////////////////

            
            
                    ////////////////////////////////////////////////////////////////////////////////////////////////////                         
                    ////        HIGHLIGHTING the cities one by one:
                    var city_idx = 0; //data.id starts at 1        
                    //Every 300 msec: highlight a new city:
                    var city_play = setInterval(function() {
                        city_idx++;
                        // Control the radius of ALL circles!
                        pathproj.pointRadius(function(d,i) { 
                            //your biz logic 
                            if (i < city_idx){
                              return 12
                            } else 
                              return 4
                        });

                        //select all elements with class city
                        d3.selectAll(".city").attr("class", 
                            function(d, i){
                            if (i < city_idx){
                              return "city highlight"
                            } else 
                              return "city"
                          }).attr("d", pathproj);

                        
//                           d3.selectAll(".city highlight").data().datum(function(d) {return d3.geo.circle().angle(30)()}) 
                           
                           
                        var len =  d3.selectAll(".city").data().length;
//                        console.log(city_idx, len)
                        //Stop when all cities are highlighted
                        if(city_idx>=len){
                            clearInterval(city_play) //terminates calls to update function within setInterval function.
                            };
                      }, 300);
                
                
                }; // end plot_points function
        
        
        
        
            ////////////////////////////////////////////////////////////////////////////////////////////////////
            ////////Group clusters of stars on body parts of mother earth
            ////////To ighlight the swabbed body parts during music!
            //////// Based on:  http://blockbuilder.org/mbostock/1021953    
            ////////////////////////////////////////////////////////////////////////////////////////////////////

            // locations of the nodes:
            // ear: 
        var earx = 370, eary = 390, ear2x = 525, ear2y = 390;
            // mouth:
        var mouthx = 450, mouthy = 435;
            // hand:
        var handx = 490, handy = 750, hand2x = 900, hand2y = 580;
            // belly:
        var bellyx = 465, bellyy = 660;
            // feet:
        var feetx = 550, feety = 960;
        
        
        
        var focieall = [{x: earx, y: eary}, {x: ear2x, y: ear2y}, {x: mouthx, y: mouthy}, {x: handx, y: handy}, {x: hand2x, y: hand2y}, {x: bellyx, y: bellyy}, {x: feetx, y: feety} ];
        var focieear = [{x: earx, y: eary}, {x: ear2x, y: ear2y}];
        var fociemouth = [{x: mouthx, y: mouthy}];
        var fociehands = [{x: handx, y: handy}, {x: hand2x, y: hand2y}];
        var fociebelly = [{x: bellyx, y: bellyy}];
        var fociefeet = [{x: feetx, y: feety} ];

        
        
        function allstars(foci, delay, callback) {
             
            var counter = 0;
            
            setTimeout(function() {
            
            callback(null);
               

        
            var nodes = [];
//                foci = [{x: earx, y: eary}, {x: ear2x, y: ear2y}, {x: mouthx, y: mouthy}, {x: handx, y: handy}, {x: hand2x, y: hand2y}, {x: bellyx, y: bellyy}, {x: feetx, y: feety} ];

            var force = d3.layout.force()
                .nodes(nodes)
                .links([])
//            .linkStrength(0.9)
//            .linkDistance(1)
//            .charge(2000)
                .gravity(0)
            .friction(0.4) // I added
                .size([width, height])
                .on("tick", tick);

            var node = svg.selectAll("circle");

            function tick(e) {
              var k = .5 * e.alpha; // k is important parameter in determining speed and distance of particles

                // Push nodes toward their designated focus.
              nodes.forEach(function(o, i) {
                o.y += (foci[o.id].y - o.y) * k;
                o.x += (foci[o.id].x - o.x) * k;
              });

              node
                  .attr("cx", function(d) { return d.x; })
                  .attr("cy", function(d) { return d.y; });
            };
            
            var IntervalId = setInterval(function(){
                
              counter++;
                
              nodes.push({id: ~~(Math.random() * foci.length)}); // ~~ is: Math.floor
              force.start();

                node = node.data(nodes);
                var rscale = d3.scale.linear()
                            .domain([0,1])
                            .range([2,8])
                
              node.enter().append("circle")
                  .attr("class", "node")
                  .attr("cx", function(d) { return d.x; })
                  .attr("cy", function(d) { return d.y; })
//                  .attr("r", 3)
                  .attr("r", function(d,i) { return rscale(Math.random());})
//                  .style("fill", function(d,i) { return color(d.id); })
//                  .style("stroke", function(d) { return d3.rgb(fill(d.id)).darker(2); })
                  .call(force.drag);
                
                    //Twinkle script from: http://blockbuilder.org/pmplewa/0e36cce6c9c5edb31e18d41ad1f82c4e */
                    d3.selectAll(".node")
                        .each(function() {
                          var circle = d3.select(this);                           
                          (function twinkle() {
                            circle.transition()
                              .duration(100 + 480 * Math.random())
                              .ease("linear")
                              .attr("opacity", 0.3 + 0.99 * Math.random())
                              .each("end", twinkle);
                          })();
                        }); //end twinkle
                      
//                console.log(counter);
                
                
                if (counter>50){clearInterval(IntervalId)};
                    
                }, 100); //repeat interval every 100msec
             
                
                
            }, delay);
        };
        
//        allstars(focieear);
//        allstars(fociefeet);
//        
        d3.queue()
            .defer(allstars,focieear, 100)
            .defer(allstars,fociebelly, 10000)
            .defer(allstars,fociefeet, 20000)
            .defer(allstars,fociemouth, 30000)
            .defer(allstars,fociehands, 40000)
//            .defer(allstars,focieear, 100, 100)
//            .defer(allstars,fociebelly, 10000, 80)
//            .defer(allstars,fociefeet, 20000, 100)
//            .defer(allstars,fociemouth, 30000, 30)
//            .defer(allstars,fociehands, 40000, 100)
            .await(function(error) {
              if (error) throw error;
              console.log("Goodbye!");
            });
        
        ////////////////////////////////////////////////////////////////////////////////////////////////////
        // loading igem data 
//        d3.csv("./data/igem/igem_team_data_and_gps.csv", function(d) {
//        d3.csv("./data/igem/igem_team_gps_sorted_by_country.csv", function(d) {
        d3.csv("./igem_data/igem_team_gps_sorted_by_lon-lat.csv", function(d) {
          d['id'] = +d['id'];
          d['lat'] = +d['lat'];
          d['lon'] = +d['lon'];
          return d;
        }, plot_points);
          
    }; // end of draw function
    ////////////////////////////////////////////////////////////////////////////////////////////////////
        
        
        
        
      </script>
  </head>
    
    
<body>
    <div id="content">
        <svg></svg>
        <div id="MotherEarth">                        
            <img id="image" src="./images/motherearth.png" width="110%"></img>
        </div>
    </div>
    
    <script type="text/javascript">
      d3.json("./graphdata/world_countries.json", function(error, geo_data) {
            draw(geo_data)
            });
        
    </script>
</body>
</html>
